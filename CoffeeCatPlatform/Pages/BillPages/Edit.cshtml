@page
@model CoffeeCatPlatform.Pages.BillPages.EditModel
@{
}
<h1>Edit Bill</h1>
<form method="post">

    <div asp-validation-summary="All" class="text-danger"></div>

    <table class="table">
        <thead>
            <tr>
                <th>Product ID</th>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Select</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in Model.Products)
            {
                var isChecked = Model.SelectedProducts.Contains(product.ProductId);

                <tr>
                    <td>@product.ProductId</td>
                    <td>@product.Name</td>
                    <td>@product.Price</td>
                    <td><input type="number" name="productQuantities[@product.ProductId]" min="0" value="@GetQuantity(product.ProductId)" /></td>
                    <td><input type="checkbox" name="selectedProducts" value="@product.ProductId" @(isChecked ? "checked" : "")
                               onchange="handleCheckboxChange(this, document.getElementsByName('productQuantities[@product.ProductId]')[0])" />
                    </td>

                </tr>
            }
        </tbody> 
    </table>

    <label for="promotionId">Select Promotion:</label>
    <select id="promotionId" name="promotionId">
        @foreach (var promotion in Model.Promotions)
        {
            if (Model.SelectedPromotions.Contains(promotion.PromotionId))
            {
                <option value="@promotion.PromotionId" selected>@promotion.Name</option>
            }
            else
            {
                <option value="@promotion.PromotionId">@promotion.Name</option>
            }
        }
    </select>
    </br> 
    
    <label for="reservationId">Select Reservation For Today:</label>
    <select id="reservationId" name="reservationId">
        @if (Model.Reservations.Any() == false)
        {
            <option value="">No reservations available</option>
        }
        @foreach (var reservation in Model.Reservations)
        {
            if (Model.SelectedReservations.Contains(reservation.ReservationId))
            {
                <option value="@reservation.ReservationId" selected>@reservation.Customer.Name</option>
            }
            else
            {
                <option value="@reservation.ReservationId">@reservation.Customer.Name</option>
            }
        }
    </select>
    </br>

    <label for="note">Note:</label>
    <textarea id="note" name="note" rows="4" cols="50">@Model.Bill.Note</textarea>
    </br>

    <input type="submit" value="Edit Bill" />
</form>

<div>
    <a asp-page="Index">Back to List</a>
</div>


<script>
    function handleCheckboxChange(checkbox, quantityInput) {
        if (checkbox.checked) {
            // Checkbox is checked, set quantity to 1
            quantityInput.value = 1;
        } else {
            // Checkbox is unchecked, set quantity to 0 or handle as needed
            quantityInput.value = 0;
        }
    }
</script>

@functions {
    int GetQuantity(int productId)
    {
        return Model.BillProducts.FirstOrDefault(bp => bp.ProductId == productId)?.Quantity ?? 0;
    }
}